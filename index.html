<html>
    <head>
        <title>CS 498 Data Visualization Narrative Project</title>
    </head>
 
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src="sankey.js"></script>
    <style>
        rect {fill: lightblue; stroke: black; }

        .node rect {
        cursor: move;
        fill-opacity: .9;
        shape-rendering: crispEdges;
        }

        .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
        }

        .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
        }

        .link:hover {
        stroke-opacity: .5;
        }

    </style>

    <body>
        <h1>CS 498 Narrative Project</h1>
        <p>This is my project.</p>
        <svg width=300 height=300>
        </svg>
        <script>
            var data2 = [4,8,15,16,23,42];
            
            var height = 200
            var width = 300
            var xs = d3.scaleBand().domain(data2).range([0,200]);
            var ys = d3.scaleLinear().domain([0,42]).range([200, 0]);
            var margin = 50
            d3.select("svg")
            .append("g")
                .attr("transform","translate("+margin+","+margin+")")
            .selectAll('rect')
            .data(data2)
            .enter()
            .append("rect")
                .attr("x", function(d,i) {return xs(d)})
                .attr("y", function(d,i) {return ys(d)})
                .attr("width",200/6)
                .attr("height", function(d) {return 200-ys(d);});
            d3.select("svg").append("g")
                .attr("transform","translate("+margin+","+margin+")")
                .call(d3.axisLeft(ys));
            d3.select("svg").append("g")
                .attr("transform","translate("+margin+","+(height+margin)+")")
                .call(d3.axisBottom(xs));        
        </script>
        <h2>Sankey Example</h2>
        <p>Test for sankey</p>
        <script>
	
            var units = "Widgets";
            
            // set the dimensions and margins of the graph
            var margin = {top: 10, right: 10, bottom: 10, left: 10},
                width = 700 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;
            
            // format variables
            var formatNumber = d3.format(",.0f"),    // zero decimal places
                format = function(d) { return formatNumber(d) + " " + units; },
                color = d3.scaleOrdinal(d3.schemeCategory10);
            
            // append the svg object to the body of the page
            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", 
                      "translate(" + margin.left + "," + margin.top + ")");
            
            // Set the sankey diagram properties
            var sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(40)
                .size([width, height]);
            
            var path = sankey.link();
            
            // load the data
            d3.csv("sankey.csv").get(function(error, data) {
             
              //set up graph in same style as original example but empty
              graph = {"nodes" : [], "links" : []};
            
              data.forEach(function (d) {
                graph.nodes.push({ "name": d.source });
                graph.nodes.push({ "name": d.target });
                graph.links.push({ "source": d.source,
                                   "target": d.target,
                                   "value": +d.value });
               });
            
              // return only the distinct / unique nodes
              graph.nodes = d3.keys(d3.nest()
                .key(function (d) { return d.name; })
                .object(graph.nodes));
            
              // loop through each link replacing the text with its index from node
              graph.links.forEach(function (d, i) {
                graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
                graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
              });
            
              // now loop through each nodes to make nodes an array of objects
              // rather than an array of strings
              graph.nodes.forEach(function (d, i) {
                graph.nodes[i] = { "name": d };
              });
            
              sankey
                  .nodes(graph.nodes)
                  .links(graph.links)
                  .layout(32);
            
              // add in the links
              var link = svg.append("g").selectAll(".link")
                  .data(graph.links)
                .enter().append("path")
                  .attr("class", "link")
                  .attr("d", path)
                  .style("stroke-width", function(d) { return Math.max(1, d.dy); })
                  .sort(function(a, b) { return b.dy - a.dy; });
            
              // add the link titles
              link.append("title")
                    .text(function(d) {
                        return d.source.name + " â†’ " + 
                            d.target.name + "\n" + format(d.value); });
            
              // add in the nodes
              var node = svg.append("g").selectAll(".node")
                  .data(graph.nodes)
                .enter().append("g")
                  .attr("class", "node")
                  .attr("transform", function(d) { 
                      return "translate(" + d.x + "," + d.y + ")"; })
                  .call(d3.drag()
                    .subject(function(d) {
                      return d;
                    })
                    .on("start", function() {
                      this.parentNode.appendChild(this);
                    })
                    .on("drag", dragmove));
            
              // add the rectangles for the nodes
              node.append("rect")
                  .attr("height", function(d) { return d.dy; })
                  .attr("width", sankey.nodeWidth())
                  .style("fill", function(d) { 
                      return d.color = color(d.name.replace(/ .*/, "")); })
                  .style("stroke", function(d) { 
                      return d3.rgb(d.color).darker(2); })
                .append("title")
                  .text(function(d) { 
                      return d.name + "\n" + format(d.value); });
            
              // add in the title for the nodes
              node.append("text")
                  .attr("x", -6)
                  .attr("y", function(d) { return d.dy / 2; })
                  .attr("dy", ".35em")
                  .attr("text-anchor", "end")
                  .attr("transform", null)
                  .text(function(d) { return d.name; })
                .filter(function(d) { return d.x < width / 2; })
                  .attr("x", 6 + sankey.nodeWidth())
                  .attr("text-anchor", "start");
            
              // the function for moving the nodes
              function dragmove(d) {
                d3.select(this)
                  .attr("transform", 
                        "translate(" 
                           + d.x + "," 
                           + (d.y = Math.max(
                              0, Math.min(height - d.dy, d3.event.y))
                             ) + ")");
                sankey.relayout();
                link.attr("d", path);
              }
            });
            
            </script>
    </body>

</html>
